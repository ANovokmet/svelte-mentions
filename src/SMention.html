<textarea class="text-input"
	on:keydown="preventArrowKeys(event)"
	on:keyup="updateValue(this.value, event)"
	on:click="updateValue(this.value, event)"
	ref:input></textarea>
<div class="dropdown" class:hidden="!dropdownOpened">
	<ul class="items">
		{#each matches as match}
			<li class="{activeConfig.itemClass}" class:selected="selected===match" on:click="enterSelection(match)">
				{@html activeConfig.template(match, query)}
			</li>
		{/each}
	</ul>
	<div class="results">
		Showing {matches.length} results.
	</div>
</div>

<script>
	const KEY_CODE = {
		up: 38,
		down: 40,
		enter: 13
	}

	export default {
		oncreate(){
			const { inputValue } = this.get();
			this.refs.input.value = inputValue;
		},
		methods: {
			preventArrowKeys(event){
				const {dropdownOpened} = this.get();
				if(dropdownOpened && event.which === KEY_CODE.up){
					this.moveSelectionUp();
					event.preventDefault();
				}
				else if(dropdownOpened && event.which === KEY_CODE.down){ 
					this.moveSelectionDown();
					event.preventDefault();
				}
				else if(dropdownOpened && event.which === KEY_CODE.enter){
					const {selected} = this.get();
					this.enterSelection(selected);
					event.preventDefault();
				}
			},
			updateValue(value, event) {
				const inputValue = value;
				this.set({inputValue});

				const { dropdownOpened } = this.get();
				//block arrowkeys from updating input
				if(dropdownOpened && (event.which === 38 || event.which === 40 || event.which === 13)){
					return false;
				}

				const cursorPosition = this.refs.input.selectionStart;
				const inputToCursor = inputValue.slice(0, cursorPosition);
				console.log('input to c', inputToCursor);

				const { configs } = this.get();
				let matches = [], activeConfig = null;

				configs.forEach(config => {
					const parsed = inputToCursor.match(new RegExp(config.delimiter + '[\\w\\s]+$', "g")); //\p{L} for localized

					console.log('parsed' + config.delimiter, parsed);
					if(parsed){
						const result = parsed[parsed.length-1].substring(1);//remove delimiter (1 char)
						console.log(result);
						this.set({query: result});
						//todo extract
						matches = config.filter(config.options, result);
						//matches.forEach(m => m.html = this.getHtml(m.name, result));
						activeConfig = config;

					}
					
					config.decode(inputValue, config.options);
				});

				if(matches.length > 0){
					this.set({dropdownOpened: true, selected: matches[0], activeConfig});
				}
				else{
					this.set({dropdownOpened: false, selected: null});
				}

				this.set({matches});
				
			},
			moveSelectionDown() {
				const {selected, matches} = this.get();
				const index = matches.indexOf(selected);
				if(index < matches.length - 1) {
					this.set({selected: matches[index + 1]});
				}
			},
			moveSelectionUp() {
				const {selected, matches} = this.get();
				const index = matches.indexOf(selected);
				if(index >= 1) {
					this.set({selected: matches[index - 1]});
				}
			},
			enterSelection(selected) {
				const { activeConfig, inputValue } = this.get();
				const cursorPosition = this.refs.input.selectionStart;

				const inputToCursor = inputValue.slice(0, cursorPosition);
				const parsed = inputToCursor.match(new RegExp(activeConfig.delimiter + '[\\w\\s]+$', "g")); //\p{L} for localized
				if(parsed) {
					const result = parsed[parsed.length-1];
					//replace last occurence
					//new RegExp(result + '$') + new RegExp('^' + result)
					const newInput = inputToCursor.replace(new RegExp(result + '$'), activeConfig.encode(selected) + ' ') + inputValue.slice(cursorPosition, inputValue.length);
					this.set({inputValue: newInput, dropdownOpened: false});
					this.refs.input.value = newInput;
				}
			}
		},
		data() {
			return { 
				configs: [],
				inputValue: '',
				query: '',
				matches: [],
				activeConfig: null,
				dropdownOpened: false,
				selected: null
			}
		}
	};
</script>


<style>
	.text-input {
		width: 800px;
  		resize: none;
	}

	.dropdown {
		width: 800px;    
		box-sizing: border-box;
		border: 1px solid #ccc;
	}

	.dropdown.hidden {
		display: none;
	}

	.item:hover {
		background-color: rgba(234,234,234,1);
	}

	.item.selected {
		background-color: rgba(222,236,249,1);
	}


	.items {
		list-style: none;
		margin: 0;
    	padding: 0;
	}

	.item {
		display: block;
		height: 40px;
	}

	.image {
		vertical-align: top;
		margin: 4px;
		float: left;
		height: 32px;
    	width: 32px;
    	border-radius: 16px;
	}

	.label {
		box-sizing: border-box;
		height: 40px;
		padding-bottom: 4px;
    	padding-top: 4px;
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
		word-wrap: normal;
	}

	.title {
		font-size: 12px;
    	line-height: 12px;
    	padding-top: 3px;
    	padding-bottom: 2px;
	}

	.subtitle {
		font-size: 12px;
		color: rgba(0,0,0,.55);
		padding-bottom: 3px;
		line-height: 12px;
	}

	.results {
		padding: 4px;
    	height: 24px;
		color: rgba(0,0,0,.55);
		font-size: 14px;
		box-sizing: border-box;
	}
</style>